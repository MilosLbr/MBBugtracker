@using Microsoft.AspNetCore.Identity
@model IEnumerable<DataModels.ViewModels.TicketListViewModel>

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


    <p id="userId" data-userid="@ViewBag.userId" class="d-none"></p>
    <h1>My tickets</h1>

    <p>
        <a asp-action="Create">Create New</a>
    </p>  

    <div class=" ticketListContainer">
        <table  id="ticketsTable" class="table table-striped">
            <thead class="table-dark table-bordered">
                <tr>
                    <th >Title</th>
                    <th>Project</th>
                    <th>Reported by</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Type</th>
                    <th>Created on</th>
                    <th>Due date</th>
                    <th>Assigned to</th>
                </tr>
            </thead>
        </table>
    </div>


@section scripts
{ 
    <script>
        $(document).ready(() => {

            let ticketTable = $("#ticketsTable").DataTable({
                ajax: {
                    "url": "/api/tickets",
                    "dataSrc": ""
                },
                aaSorting: [],
                columns: [
                    {
                        "data": "title",
                        "render": (data, type, ticket) => {
                            let userId = $("#userId").data("userid");
                            let detailsHref = "/Tickets/Details/" + ticket.id;
                            let infoCircle = '<a href=' + detailsHref +'><i class="fa fa-info-circle" aria-hidden="true" title="Details"></i></a>';

                            if (userId == ticket.applicationUser.id) {
                                let editHref = "/Tickets/Edit/" + ticket.id;
                                return "<a" + " href=" + editHref + ">" + ticket.title + "&nbsp;" + infoCircle + "</a>";
                            } else {
                                return "<a>" + ticket.title +"&nbsp" + infoCircle + "</a>"
                            }

                        }
                    },
                    { "data": "project.projectName" },
                    { "data": "applicationUser.userName" },
                    { "data": "ticketPriority.priorityName" },
                    { "data": "ticketStatus.statusName" },
                    { "data": "ticketType.typeName" },
                    {
                        "data": "createdOn",
                        "render": (data) => {
                            let date = new Date(data);
                            let formated = moment(date).format("DD.MM.YYYY");
                            let dateForSort = moment(date).format("YYYYMMDD");
                            return "<span class='hiddenDate'>"+ dateForSort + "</span>" +  formated;
                        }
                    },
                    {
                        "data": "dueDate",
                        "render": (data) => {
                            let date = new Date(data);
                            let formated = moment(date).format("DD.MM.YYYY");
                            let dateForSort = moment(date).format("YYYYMMDD");
                            return "<span class='hiddenDate'>" + dateForSort + "</span>" + formated;
                        }
                    },
                    { "data": "assignedTo" }
                ],
                "columnDefs": [
                    { "width": "200px", "targets": 0 }
                ]
            });
        })
    </script>
}